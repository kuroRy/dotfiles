name: "Dotfiles CI"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  # macOS テスト（Apple Silicon / M1）
  macos-arm-test:
    name: macOS テスト (Apple Silicon)
    runs-on: macos-14 # Apple Silicon (M1/M2/M3)
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: プラットフォーム情報を表示
        run: |
          echo "=== システム情報 ==="
          uname -a
          echo "=== アーキテクチャ ==="
          uname -m
          echo "=== macOSバージョン ==="
          sw_vers
          echo "=== Homebrewパス確認 ==="
          echo "Expected: /opt/homebrew (Apple Silicon)"

      - name: アーキテクチャ検証
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" != "arm64" ]; then
            echo "ERROR: Expected arm64, got $ARCH"
            exit 1
          fi
          echo "✓ Apple Silicon (arm64) confirmed"

      - name: 基本テストを実行
        run: make test

      - name: dotfilesセットアップ（init + link のみ）
        run: |
          # ホームディレクトリにdotfilesディレクトリを作成
          cp -r . $HOME/dotfiles
          cd $HOME/dotfiles
          make init
          make link

      - name: 設定検証を実行
        run: |
          cd $HOME/dotfiles
          make verify
        continue-on-error: true

      - name: anyenv セットアップテスト
        run: |
          cd $HOME/dotfiles
          local/bin/anyenv.sh test
        continue-on-error: true
